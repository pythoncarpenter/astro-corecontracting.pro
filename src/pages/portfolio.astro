---
export const prerender = false;

import Layout from '../layouts/Layout.astro';

const topImages = [
  '/images/Top1.png',
  '/images/Top2.png',
  '/images/Top3.png',
  '/images/Top4.png',
  '/images/Top5.png',
  '/images/Top6.png',
  '/images/Top7.png',
  '/images/Top8.png',
  '/images/Top9.png',
  '/images/Top10.png',
];

const projectImages = [
  '/images/placeholder_1.png',
  '/images/placeholder_2.png',
  '/images/placeholder_3.png',
  '/images/placeholder_4.png',
  '/images/placeholder_5.png',
  '/images/placeholder_6.png',
];
---

<Layout title="Portfolio - Core Contracting">
  <div
    id="rotate-banner"
    class="hidden fixed top-0 left-0 w-full bg-yellow-300 text-black text-center p-3 z-[999]"
  >
    Please rotate your device to landscape for the best experience.
  </div>

  <h1 class="text-4xl font-serif font-bold text-center mt-20 mb-8">
    Our Portfolio
  </h1>

  <section
    id="carousel-wrapper"
    class="relative transition-all duration-300 ease-in-out"
  >
    <div
      id="carousel-container"
      class="relative w-full h-64 bg-black overflow-hidden"
    >
      {topImages.map((image, index) => (
        <div 
          class="absolute top-0 left-0 w-full h-full flex justify-center items-center transition-transform duration-300"
          style={`transform: translateX(${100 * index}%)`}
        >
          <img
            src={image}
            alt={`Slide ${index + 1}`}
            class="h-full w-auto object-contain"
          />
        </div>
      ))}
    </div>

    <div class="absolute bottom-[-2.5rem] left-0 right-0 flex justify-center gap-4 items-center">
      <button
        id="carousel-prev"
        class="px-3 py-1 bg-gray-300 dark:bg-gray-700 rounded text-black dark:text-white"
      >
        &larr;
      </button>
      <span id="slide-number" class="text-sm min-w-[60px] text-center">1 / {topImages.length}</span>
      <button
        id="carousel-next"
        class="px-3 py-1 bg-gray-300 dark:bg-gray-700 rounded text-black dark:text-white"
      >
        &rarr;
      </button>
    </div>
  </section>

  <div
    id="portfolio-cards"
    class="container mx-auto px-4 py-12 transition-all duration-300 ease-in-out"
  >
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {projectImages.map((imagePath, index) => (
        <div
          class="bg-white dark:bg-primary-800 rounded-lg shadow-lg overflow-hidden"
        >
          <img
            src={imagePath}
            alt={`Project ${index + 1}`}
            class="w-full h-64 object-cover"
          />
          <div class="p-6">
            <h2 class="text-2xl font-bold mb-2">
              Project {index + 1}
            </h2>
            <p class="text-primary-600 dark:text-primary-300 mb-4">
              Lorem ipsum dolor sit amet.
            </p>
            <button
              class="bg-wood-dark hover:bg-wood text-white px-4 py-2 rounded-lg transition-colors"
            >
              View Project
            </button>
          </div>
        </div>
      ))}
    </div>
  </div>
</Layout>

<script>
  function isMobilePortrait() {
    return (
      window.matchMedia('(max-width: 767px)').matches &&
      (window.orientation === 0 || window.orientation === 180)
    );
  }

  function isMobileLandscape() {
    return (
      window.matchMedia('(max-width: 767px)').matches &&
      (window.orientation === 90 || window.orientation === -90)
    );
  }

  let landscapeLocked = false;

  function showBanner() {
    document.getElementById('rotate-banner')?.classList.remove('hidden');
  }

  function hideBanner() {
    document.getElementById('rotate-banner')?.classList.add('hidden');
  }

  function applyFullscreen() {
    const wrapper = document.getElementById('carousel-wrapper');
    const container = document.getElementById('carousel-container');
    if (!wrapper || !container) return;

    wrapper.style.backgroundColor = 'black';
    wrapper.style.position = 'fixed';
    wrapper.style.top = '0';
    wrapper.style.left = '0';
    wrapper.style.width = '100vw';
    wrapper.style.height = '100vh';
    wrapper.style.zIndex = '50';

    container.style.width = '100vw';
    container.style.height = '100vh';
  }

  function revertInline() {
    const wrapper = document.getElementById('carousel-wrapper');
    const container = document.getElementById('carousel-container');
    if (!wrapper || !container) return;

    wrapper.style.backgroundColor = '';
    wrapper.style.position = '';
    wrapper.style.top = '';
    wrapper.style.left = '';
    wrapper.style.width = '';
    wrapper.style.height = '';
    wrapper.style.zIndex = '';

    container.style.width = '';
    container.style.height = '';
  }

  function updateLayout() {
    if (landscapeLocked) return;

    if (isMobileLandscape()) {
      hideBanner();
      applyFullscreen();
      landscapeLocked = true;
    } else {
      if (isMobilePortrait()) {
        showBanner();
      } else {
        hideBanner();
      }
      revertInline();
    }
  }

  document.addEventListener('astro:page-load', () => {
    updateLayout();
    window.addEventListener('orientationchange', updateLayout);
    window.addEventListener('resize', updateLayout);

    const container = document.getElementById('carousel-container');
    const prevBtn = document.getElementById('carousel-prev');
    const nextBtn = document.getElementById('carousel-next');
    const slideNumber = document.getElementById('slide-number');
    
    if (!container || !prevBtn || !nextBtn || !slideNumber) return;

    const slides = Array.from(container.children);
    const totalSlides = slides.length;
    let currentSlide = 0;
    let isTransitioning = false;
    let lastClickTime = 0;
    const CLICK_DELAY = 400;

    function showSlide(idx) {
      if (idx < 0) idx = totalSlides - 1;
      if (idx >= totalSlides) idx = 0;
      currentSlide = idx;

      slides.forEach((slide, index) => {
        slide.style.transform = `translateX(${100 * (index - currentSlide)}%)`;
      });

      slideNumber.textContent = `${currentSlide + 1} / ${totalSlides}`;
    }

    // Separate handling for button clicks vs swipes
    function handleButtonClick(direction) {
      const now = Date.now();
      if (isTransitioning || (now - lastClickTime) < CLICK_DELAY) return;
      
      isTransitioning = true;
      lastClickTime = now;
      
      showSlide(currentSlide + direction);
      
      setTimeout(() => {
        isTransitioning = false;
      }, CLICK_DELAY);
    }
    
    prevBtn.addEventListener('click', () => handleButtonClick(-1));
    nextBtn.addEventListener('click', () => handleButtonClick(1));

    // Touch handling with smoother transitions
    let touchStartX = 0;
    let touchStartTime = 0;
    let isSwiping = false;

    container.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartTime = Date.now();
      isSwiping = true;
    });

    container.addEventListener('touchmove', (e) => {
      if (!isSwiping) return;
      
      const currentX = e.touches[0].clientX;
      const deltaX = currentX - touchStartX;
      
      // Move all slides with the finger
      slides.forEach((slide, index) => {
        const offset = (index - currentSlide) * 100;
        slide.style.transform = `translateX(calc(${offset}% + ${deltaX}px))`;
        slide.style.transition = 'none'; // Remove transition during touch move
      });
    });

    container.addEventListener('touchend', (e) => {
      if (!isSwiping) return;
      isSwiping = false;
      
      const touchEndX = e.changedTouches[0].clientX;
      const deltaX = touchEndX - touchStartX;
      const timeTaken = Date.now() - touchStartTime;
      
      // Calculate velocity (pixels per millisecond)
      const velocity = Math.abs(deltaX) / timeTaken;
      
      // Determine if swipe should trigger slide change
      // Either by distance (>50px) or by speed (>0.5 pixels/ms)
      if (Math.abs(deltaX) > 50 || velocity > 0.5) {
        // Re-enable transitions for the snap
        slides.forEach(slide => {
          slide.style.transition = 'transform 0.3s ease-out';
        });
        
        if (deltaX > 0) {
          showSlide(currentSlide - 1);
        } else {
          showSlide(currentSlide + 1);
        }
      } else {
        // If the swipe wasn't far/fast enough, snap back
        slides.forEach(slide => {
          slide.style.transition = 'transform 0.3s ease-out';
          const offset = (index - currentSlide) * 100;
          slide.style.transform = `translateX(${offset}%)`;
        });
      }
    });

    container.addEventListener('touchcancel', () => {
      if (!isSwiping) return;
      isSwiping = false;
      
      // Reset positions on cancel
      slides.forEach((slide, index) => {
        slide.style.transition = 'transform 0.3s ease-out';
        const offset = (index - currentSlide) * 100;
        slide.style.transform = `translateX(${offset}%)`;
      });
    });

    let startY = null;
    const wrapper = document.getElementById('carousel-wrapper');
    if (wrapper) {
      wrapper.addEventListener('touchstart', (e) => {
        startY = e.touches[0].clientY;
      });
      
      wrapper.addEventListener('touchmove', (e) => {
        if (startY === null) return;
        const currentY = e.touches[0].clientY;
        const diff = startY - currentY;
        if (diff < -80 && landscapeLocked) {
          landscapeLocked = false;
          revertInline();
        }
      });
      
      wrapper.addEventListener('touchend', () => {
        startY = null;
      });
    }

    showSlide(0);
  });
</script>